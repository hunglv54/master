var extend=function(t,e){function i(){this.constructor=t}for(var n in e)hasProp.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;define(["external/underscore","modules/core/exception","modules/clean/activity/activity","modules/clean/activity/comment","modules/clean/activity/like","modules/clean/immutability_helper"],function(t,e,i,n,r,o){var c,a,u,p,s,m,l,v,f,y,h,d,_,g,k,A,b;return m=e.assert,c=i.CommentActivity,a=i.FileActivity,k=o.updateIn,f=o.getIn,g=o.splice,_=o.push,h=o.merge,A=function(e){return t.matcher({activity_key:e})},b=t.compose(t.negate,A),y=function(t){return function(e){var i;return i=e.liker,i.id===t}},d=t.compose(t.negate,y),l=function(t,e,i){var n,r,o,c,a,u,p,s,m,l,v;if(null==i&&(i=!1),(a=A(e))(t))return[];for(m=t.comment_activities,o=r=0,p=m.length;p>r;o=++r){if(n=m[o],a(n))return["comment_activities",o];if(!i)for(l=n.comment_activities,c=u=0,s=l.length;s>u;c=++u)if(v=l[c],a(v))return["comment_activities",o,"comment_activities",c]}return null},v=function(t,e,i){var n;if(n=l(t,e,i),null==n)throw Error("Cannot find activity with the key: "+e);return n},u=function(e){function i(){}return extend(i,e),i.fromMutable=function(e){return t.create(i.prototype,e)},i}(n),p=function(e){function i(){}return extend(i,e),i.fromMutable=function(e){var n;return n=t.create(i.prototype,e),n.comment=u.fromMutable(n.comment),n.comment_activities=n.comment_activities.map(i.fromMutable),n},i}(c),s=function(e){function i(){}return extend(i,e),i.fromMutable=function(e){var n;return n=t.create(i.prototype,e),n.comment_activities=n.comment_activities.map(p.fromMutable),n},i.prototype.findActivityByKey=function(t){var e;return e=l(this,t),null!=e?f(this,e):null},i.prototype.purgeActivity=function(e){var i,n;return n=l(this,e),null==n?this:(m(n.length>0,"Cannot purge root activity"),i=n.pop(),k(this,n,t.partial(g,t,[[i,1]])))},i.prototype.updateDeleteActivity=function(e,i){var n;return n=l(this,e),null==n?this:k(this,n,t.partial(h,t,{isDeleted:i}))},i.prototype.appendActivity=function(e,i){var n;return n=v(this,e,!0),n.push("comment_activities"),k(this,n,t.partial(_,t,[i]))},i.prototype.updateResolveActivity=function(e,i){var n;return n=v(this,e),n.push("comment"),k(this,n,t.partial(h,t,{resolved:i}))},i.prototype.updateLikeActivity=function(t,e,i){var n;return n=v(this,t),n.push("likes"),k(this,n,function(t){var n;return e?(n=new r({liker_dict:i,when_mses:Date.now()}),_(t,[n])):t.filter(d(i.id))})},i.prototype.updateActivityStatus=function(e,i){var n;return n=v(this,e),k(this,n,t.partial(h,t,{status:i}))},i.prototype.updateEnableActivity=function(t){return h(this,{feedback_off:!t})},i.prototype.markCommentsSeen=function(e){var i,n;return n=v(this,e),m(n.length>0,"Cannot mark root activity as seen"),i=n.pop(),n.pop(),k(this,n,t.partial(h,t,{seen_comment_count:1+i}))},i.prototype.union=function(e){var i;return i=t.indexBy(e.comment_activities,"activity_key"),this.comment_activities.forEach(function(t){var n,r,o;return null!=t.isPending?e.comment_activities.push(t):(n=null!=i[t.activity_key],r=t.getPendingCommentActivities(),r.length&&null!=n?(o=e.comment_activities).push.apply(o,r):void 0)}),e},i}(a)});